<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>üìã Xem ƒê∆°n H√†ng</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-blue-50 min-h-screen p-6">
  <div class="max-w-6xl mx-auto">
    <h1 class="text-3xl font-bold text-center text-blue-700 mb-6">üìã Danh s√°ch ƒë∆°n h√†ng</h1>

    <!-- B·ªô l·ªçc -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
      <input type="text" id="filterTable" placeholder="üîç L·ªçc theo b√†n" class="p-2 border rounded w-full">
      <input type="time" id="filterTime" class="p-2 border rounded w-full">
      <button onclick="loadData()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">üîÅ L√†m m·ªõi</button>
    </div>

    <!-- B·∫£ng d·ªØ li·ªáu -->
    <div class="overflow-x-auto">
      <table class="min-w-full bg-white rounded shadow">
        <thead class="bg-blue-100 text-blue-800">
          <tr>
            <th class="py-2 px-4 text-left">‚è∞ Gi·ªù</th>
            <th class="py-2 px-4 text-left">üçΩÔ∏è B√†n</th>
            <th class="py-2 px-4 text-left">ü•¢ M√≥n</th>
            <th class="py-2 px-4 text-left">üßæ Ghi ch√∫</th>
          </tr>
        </thead>
        <tbody id="orderTable" class="text-gray-700"></tbody>
      </table>
    </div>

    <!-- Bi·ªÉu ƒë·ªì -->
    <div class="mt-10 bg-white rounded p-4 shadow">
      <h2 class="text-xl font-bold text-blue-700 mb-2">üìä Th·ªëng k√™ m√≥n ƒë∆∞·ª£c g·ªçi nhi·ªÅu</h2>
      <canvas id="chartFood" height="120"></canvas>
    </div>
  </div>

  <script>
    const SHEET_ID = "YOUR_SHEET_ID";
    const SHEET_NAME = "Form Responses 1";
    const API_URL = `https://docs.google.com/spreadsheets/d/1OdhpqkC5PqVZPmTuDrnAVGL_xcKJVNgQXLQd6hKAJMs/gviz/tq?tqx=out:json&sheet=${SHEET_NAME}`;

    async function loadData() {
      try {
        const res = await fetch(API_URL);
        const text = await res.text();
        const json = JSON.parse(text.substr(47).slice(0, -2));
        const rows = json.table.rows;

        const tbody = document.getElementById("orderTable");
        tbody.innerHTML = "";

        const tableFilter = document.getElementById("filterTable").value.toLowerCase();
        const timeFilter = document.getElementById("filterTime").value;

        const foodCount = {};
        for (let row of rows) {
          const time = row.c[0]?.v || "";
          const table = row.c[1]?.v || "";
          const food = row.c[2]?.v || "";
          const note = row.c[3]?.v || "";

          if (
            (!tableFilter || table.toLowerCase().includes(tableFilter)) &&
            (!timeFilter || time.startsWith(timeFilter))
          ) {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td class="py-1 px-4">${time}</td>
              <td class="py-1 px-4">${table}</td>
              <td class="py-1 px-4">${food}</td>
              <td class="py-1 px-4">${note}</td>
            `;
            tbody.appendChild(tr);

            // ƒê·∫øm m√≥n ƒÉn
            const items = food.split(",").map(f => f.trim());
            items.forEach(item => {
              foodCount[item] = (foodCount[item] || 0) + 1;
            });
          }
        }

        // C·∫≠p nh·∫≠t bi·ªÉu ƒë·ªì
        updateChart(foodCount);
      } catch (err) {
        console.error("L·ªói t·∫£i d·ªØ li·ªáu:", err);
      }
    }

    let chart;
    function updateChart(data) {
      const labels = Object.keys(data);
      const values = Object.values(data);
      if (chart) chart.destroy();
      const ctx = document.getElementById("chartFood").getContext("2d");
      chart = new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [{
            label: "S·ªë l·∫ßn g·ªçi m√≥n",
            data: values,
            backgroundColor: "rgba(59,130,246,0.7)"
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }

    window.onload = loadData;
  </script>
</body>
</html>
